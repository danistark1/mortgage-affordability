<script>
let currentMode = 'max';

function setMode(mode) {
    currentMode = mode;
    document.getElementById('modeMax').classList.toggle('active', mode === 'max');
    document.getElementById('modeSpecific').classList.toggle('active', mode === 'specific');
    document.getElementById('incomeWrapper').style.display = mode === 'max' ? 'block' : 'none';
    document.getElementById('priceWrapper').style.display = mode === 'specific' ? 'block' : 'none';
    document.getElementById('resultHeading').innerText = mode === 'max' ? 'Max Purchase (Blainville)' : 'Purchase Price';
    calculate();
}

function minDownPayment(price) {
    if (price >= 1000000) return price * 0.20;
    if (price <= 500000) return price * 0.05;
    return 25000 + (price - 500000) * 0.10;
}

function cmhcRate(dpPct, price) {
    if (price >= 1000000) return 0;
    if (dpPct >= 20) return 0;
    if (dpPct >= 15) return 0.028;
    if (dpPct >= 10) return 0.031;
    if (dpPct >= 5) return 0.04;
    return 0;
}

function mortgageFromPayment(payment, r, n) {
    if (r === 0) return payment * n;
    return payment * ((1 - Math.pow(1 + r, -n)) / r);
}

function paymentFromMortgage(mortgage, r, n) {
    if (r === 0) return mortgage / n;
    return mortgage * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
}

function welcomeTaxBlainville(price) {
    let tax = 0;

    if (price <= 62900) return price * 0.005;

    tax += 62900 * 0.005;

    if (price <= 315000)
        return tax + (price - 62900) * 0.01;

    tax += (315000 - 62900) * 0.01;

    if (price <= 552300)
        return tax + (price - 315000) * 0.015;

    tax += (552300 - 315000) * 0.015;

    return tax + (price - 552300) * 0.03; // âœ… corrected to 3%
}

function calculate() {

    const income = parseFloat(document.getElementById('income').value) || 0;
    const downPaymentInput = parseFloat(document.getElementById('downpayment').value) || 0;
    const priceInput = parseFloat(document.getElementById('purchasePrice').value) || 0;
    const debts = parseFloat(document.getElementById('loans').value) || 0;
    const annualTax = parseFloat(document.getElementById('propTax').value) || 0;
    const monthlyHeat = parseFloat(document.getElementById('heating').value) || 0;
    const monthlyCondo = parseFloat(document.getElementById('condo').value) || 0;
    const marketRate = (parseFloat(document.getElementById('rate').value) || 0) / 100;
    let years = parseInt(document.getElementById('amortization').value);

    const stressRate = Math.max(marketRate + 0.02, 0.0525);
    const rStress = stressRate / 12;
    const rMarket = marketRate / 12;

    const GDS = 0.39;
    const TDS = 0.44;

    let finalPrice = 0, baseLoan = 0, insuredMortgage = 0, cmhcTotal = 0;

    if (currentMode === 'max') {

        const fixedHousing = (annualTax / 12) + monthlyHeat + (monthlyCondo * 0.5);

        let maxPaymentGDS = (income * GDS / 12) - fixedHousing;
        let maxPaymentTDS = (income * TDS / 12) - fixedHousing - debts;

        let maxPayment = Math.min(maxPaymentGDS, maxPaymentTDS);

        if (maxPayment <= 0) {
            finalPrice = 0;
        } else {

            let priceGuess = 300000;

            for (let i = 0; i < 40; i++) {

                // Enforce $1M rule
                if (priceGuess >= 1000000 && downPaymentInput / priceGuess < 0.20) {
                    priceGuess = downPaymentInput / 0.20;
                }

                // Enforce minimum down payment
                if (downPaymentInput < minDownPayment(priceGuess)) {
                    priceGuess = downPaymentInput / 0.05;
                }

                let dpPct = (downPaymentInput / priceGuess) * 100;

                if (dpPct < 5) {
                    priceGuess = downPaymentInput / 0.05;
                    dpPct = 5;
                }

                // Insured max amortization
                if (dpPct < 20 && years > 25) {
                    years = 25;
                }

                const n = years * 12;

                baseLoan = priceGuess - downPaymentInput;
                cmhcTotal = baseLoan * cmhcRate(dpPct, priceGuess);
                insuredMortgage = baseLoan + cmhcTotal;

                let requiredPayment = paymentFromMortgage(insuredMortgage, rStress, n);

                let ratio = maxPayment / requiredPayment;

                if (!isFinite(ratio) || ratio <= 0) break;

                priceGuess *= ratio;
            }

            finalPrice = priceGuess;
        }

    } else {

        finalPrice = priceInput;

        if (downPaymentInput < minDownPayment(finalPrice)) {
            alert("Down payment below legal minimum for this price.");
        }

        let dpPct = (downPaymentInput / finalPrice) * 100;

        if (dpPct < 20 && years > 25) {
            years = 25;
            document.getElementById('amortization').value = "25";
        }

        baseLoan = finalPrice - downPaymentInput;
        cmhcTotal = baseLoan * cmhcRate(dpPct, finalPrice);
        insuredMortgage = baseLoan + cmhcTotal;
    }

    const n = years * 12;

    const monthlyPI = insuredMortgage > 0
        ? paymentFromMortgage(insuredMortgage, rMarket, n)
        : 0;

    const wTax = welcomeTaxBlainville(finalPrice);

    const fmt = new Intl.NumberFormat('en-CA', {
        style: 'currency',
        currency: 'CAD',
        maximumFractionDigits: 0
    });

    document.getElementById('mainResultDisplay').innerText = fmt.format(finalPrice);
    document.getElementById('monthlyPayment').innerText =
        fmt.format(monthlyPI + (annualTax / 12) + monthlyHeat + monthlyCondo);
    document.getElementById('piOnly').innerText = fmt.format(monthlyPI);
    document.getElementById('cmhcFee').innerText = fmt.format(cmhcTotal);
    document.getElementById('welcomeTax').innerText = fmt.format(wTax);

    generateTable(insuredMortgage, marketRate, years, monthlyPI);
}
</script>
